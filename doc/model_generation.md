# Generating the model

The model is generated by `calcmysky` utility from a text file, whose name normally has `.atmo` suffix. The command
```
calcmysky description.atmo --out-dir output-directory
```
will use the input file `description.atmo` and output the model to a directory named `output-directory`.

This utility has some options that can be listed by running it with `--help` option.

## Format of model description file

Model description files consist of entries that represent key-value pairs. Empty lines between entries are ignored, and "#" character starts comments. Single-line entries can also be followed by a comment in the same line.

Any text on a line before the first colon character ":" is considered to be key. Depending on the key, corresponding value can be one of the following:
 * a number, e.g. 123.456;
 * a dimensionful quantity (see [Dimensionful quantities](#dimensionful-quantities));
 * a spectrum (see [Spectra](#spectra))
 * a range of wavelengths, e.g. min=360nm,max=830nm,count=16;
 * a section (see [Sections](#sections)).

### <a name="dimensionful-quantities">Dimensionful quantities</a>

A dimensionful quantity is a number followed by a unit. Scientific notation is not supported. An example of a length quantity is `1.234 m`.

Several types of quantities are supported:

| Dimension         | Supported units                                                                       |
|-------------------|---------------------------------------------------------------------------------------|
| length            |                      `nm`, `um`, `mm`, `m`, `km`, `Mm`, `Gm`, `AU`                    |
|reciprocal length  |                `nm^-1`, `um^-1`, `mm^-1`, `m^-1`, `km^-1`, `Mm^-1`, `Gm^-1`           |
| area              | `am^2`, `fm^2`, `pm^2`, `nm^2`, `um^2`, `mm^2`, `cm^2`, `m^2`, `km^2`, `Mm^2`, `Gm^2` |

### <a name="spectra">Spectra</a>

Spectra are specified in predefined units, which depend on the key to which this spectrum corresponds.

There are several ways to specify a spectrum:

1. A list of numbers, which can be in normal or scientific format, separated with commas. Example:
```
    solar irradiance at TOA: 1.037, 1.249, 1.684, 1.975, 1.968, 1.877, 1.854, 1.818, 1.723, 1.604, 1.516, 1.408, 1.309, 1.23, 1.142, 1.062
```
2. A file path prepended by `file `. Example:
```
    solar irradiance at TOA: file spectra/solar-irradiance-at-toa.csv
```
3. Several files added together with weighting coefficients. A filename must be prepended with `weighted file `, and each new such entry accumulates the new values in the corresponding spectrum. Example:
```
    ground albedo: weighted file 0.8 spectra/ground-albedo-grass.csv
    ground albedo: weighted file 0.2 spectra/ground-albedo-snow.csv
```

### <a name="sections">Sections</a>

A section begins on the next line after the key, the colon character remains on the line with the key.

Top-level sections are bounded by an opening brace "{" and a closing brace "}". Nested section, which normally are code snippets, are bounded by triple backticks "```", similarly to fenced code blocks in Markdown.

Example of a section with a nested section:

    Scatterer "something":
    {
        number density:
        ```
            const float rayleighScaleHeight=8*km;
            return 3.08458e25*exp(-1/rayleighScaleHeight * altitude);
        ```
    }

### Keys and values

The `examples` directory in the source tree has a few `*.atmo` files serving as examples. Let's walk through one of them, `sample.atmo`.

    atmosphere height: 120 km
Atmosphere height is the maximum altitude at which density of some constituents of the atmosphere is considered nonzero. The sphere of all the points at this altitude is called TOA, i.e. top of atmosphere. All the textures span altitudes from 0 to atmosphere height.
Valid values for this entry are length quantities from 1&nbsp;m to 1&nbsp;Mm.

    scattering orders: 4

When a light ray propagates in the atmosphere, it can be scattered on the inhomogeneities of this medium (molecules, dust, etc.). This produces secondary rays, which, in turn, can also be scattered to produce tertiary rays, etc. The first scattering of the initial ray is called first-order scattering. Scattering of the secondary rays is second-order, and so on.

Radiance in each subsequent scattering order normally becomes smaller, approaching zero in the limit. This makes it possible to ignore the scattering events starting with some order of scattering, with negligible loss of accuracy. The `scattering orders` entry sets number of scattering orders to take into account.

    transmittance texture size for VZA: 256
    transmittance texture size for altitude: 64

Transmittance texture holds a map of percentage of light that's transmitted through the atmosphere from the TOA to the camera, given altitude of a camera and view zenith angle (VZA) of this camera. The entries above control the resolution of the transmittance texture in each of these dimensions.

    irradiance texture size for SZA: 64
    irradiance texture size for altitude: 16

Irradiance texture contains values of irradiance of a horizontal surface at the point with given altitude and zenith angle of the Sun (SZA). The entries above control the resolution of the irradiance texture in each of these dimensions.

    scattering texture size for VZA: 128
    scattering texture size for dot(view,sun): 16
    scattering texture size for SZA: 128
    scattering texture size for altitude: 64

Scattering textures are the main textures that contain the actual radiance or luminance from given direction as seen by a camera at the given altitude, with the Sun being at a given zenith angle.

VZA, SZA and altitude here are similar to the corresponding parameters in irradiance and transmittance textures.

The `dot(view,sun)` parameter determines cosine of the angular distance between the direction from the camera to the Sun and the direction of view of the camera.

For technical reasons the texture size for VZA here must be even.

    eclipsed scattering texture size for relative azimuth: 32
    eclipsed scattering texture size for VZA: 128

When solar eclipse is simulated, corresponding first-order scattering texture is computed on the fly during rendering, for the current altitude of the camera and the current positions of the Sun and the Moon. This is unlike the case of non-eclipsed calculations, where such radiance is precomputed for all altitudes and solar elevations.

Relative azimuth is the azimuth of the view direction relative to the Sun. VZA is view zenith angle, as described for transmittance texture.

    eclipsed double scattering texture size for relative azimuth: 16
    eclipsed double scattering texture size for VZA: 128
    eclipsed double scattering texture size for SZA: 16

When solar eclipse is simulated, it's only simulated for two scattering orders, because going further is prohibitively slow. Even second-order scattering is quite slow on many GPUs. These entries control precomputation of a texture that will hold second-order scattering radiance for the given view zenith angle, solar elevation, and azimuth of view relative to the Sun.

    eclipsed double scattering number of azimuth pairs to sample: 2
    eclipsed double scattering number of elevation pairs to sample: 10

Because second-order scattering is so slow to compute, radiance is sampled on a very sparse grid of points. Several circles at different azimuths are sampled at multiple elevations, with an optimized distribution of samples. The samples are taken in pairs, e.g. if one sampling direction is forward, one more will be backward.

The more samples one takes, the higher the resolution of the final second-order scattering layer.

    light pollution texture size for VZA: 128
    light pollution texture size for altitude: 64

Light pollution is simulated with the assumption that the whole Earth glows uniformly with the given luminance (which is controlled at runtime). This makes the radiance quite symmetric, depending only on altitude of the camera and zenith angle of its view direction. These entries control resolution in these parameters.

    transmittance integration points: 500
    radial integration points: 50

Computation of transmittance and inscattered radiance is done in the direction of view from camera position to the TOA. Since transmittance is stored in a 2D texture, rather than 4D, it's relatively cheap to compute it more precisely. Inscattered radiance, OTOH, is stored in a 4D texture, so `radial integration points` value has to be smaller to make the computation faster. This is especially important for eclipsed atmosphere, where this computation is done on the fly.

    angular integration points: 512
    angular integration points for eclipse: 512
    light pollution angular integration points: 200

<span style="background-color: red;">TODO</span>: write this section

    Earth-Sun distance: 1.01208 AU
    Earth-Moon distance: 371925 km
    Earth radius: 6371 km

These entries are just the physical constants used in the model. Earth-Sun distance can be from \f$0.5\,\mathrm{AU}\f$ to \f$10^{20}\,\mathrm{AU},\f$ Earth-Moon distance can be from \f$10^{-4}\,\mathrm{AU}\f$ to \f$10^{20}\,\mathrm{AU},\f$ and Earth radius can be from 100&nbsp;km to 10&nbsp;Gm.

Note that these limits are rather arbitrary, and nothing too far (like orders of magnitude difference) from the real Earth-Sun-Moon system has ever been tested.

    wavelengths: min=360nm,max=830nm,count=16

This entry describes the set of wavelengths to use. It consists of smallest wavelength (`min`), largest (`max`), and total number of wavelengths in the set (`count`). The calculations are done separately for each wavelength to obtain radiance from different directions. Then these values are saved into the textures.

After radiance is obtained, to be displayed on a screen it needs to be converted to some color space. This is done by numerically integrating the radiance with respect to the CIE 1931 color matching functions, after which the conversion to the target color space is done.

Scattering textures are stored as either spectral radiance (when requested by `--radiance` option for `calcmysky`), or as \f$XYZW\f$ luminance. \f$XYZ\f$ here are the CIE 1931 tristimulus values, and \f$W\f$ is the scotopic luminance.

    solar irradiance at TOA: 1.037,1.249,1.684,1.975,1.968,1.877,1.854,1.818,1.723,1.604,1.516,1.408,1.309,1.23,1.142,1.062


<span style="background-color: red;">TODO</span>: write this section

