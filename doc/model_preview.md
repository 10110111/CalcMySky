# Previewing atmosphere model

The model generated by `calcmysky` can be previewed using another utility, `showmysky`. You can start it and choose the model directory, or pass the directory as a command-line argument.

The window will show the preview with a toolbox, similar to the screenshot below.

\image html showmysky-screenshot.png "Screenshot of ShowMySky" width=75%

## Image window

The image displayed in the main part of the window is the scene projected onto the screen in equirectangular projection (up to aspect ratio). The top (when zoom, camera pitch and yaw have default values) corresponds to zenith, the bottom to nadir, the sides to the South, and the middle to the North.

Keyboard/mouse actions have the following effects:

 * <kbd>Ctrl</kbd> + drag: move the Sun, affects [Sun azimuth](#sun-azimuth-control) and [Sun elevation](#sun-elevation-control);
 * <kbd>Shift</kbd> + drag: change camera orientation, affects [Camera pitch](#camera-pitch-control) and [Camera yaw](#camera-yaw-control);
 * Right-mouse-button drag: the same as <kbd>Shift</kbd> + drag;
 * Left mouse button click: when Radiance plot is opened, pick a pixel to display its radiance.

## Tools widget controls

### Altitude

This manipulator defines altitude of the camera above the ground.

### log<sub>10</sub>(exposure)

This manipulator controls brightness of the scene, similar to the exposure setting of a photo camera. The numeric value is a logarithm of the actual brightness factor.

<span style="background-color: red;">TODO</span>: describe how the radiance in \f$\mathrm{cd/m^2}\f$ gets converted into the final RGB units on the display.

### <a name="sun-elevation-control">Sun elevation</a>

Elevation of the Sun over mathematical horizon.

### <a name="sun-azimuth-control">Sun azimuth</a>

Azimuth of the Sun, zero being North.

### Sun angular radius

Angular radius of the solar disk. In real life it depends on the distance between the Sun and the camera (and thus on time of year).

### Moon elevation

Elevation of the Moon over mathematical horizon. It's used the simulation of solar eclipses.

### Moon azimuth

Azimuth of the Moon, zero being North. It's used in the simulation of solar eclipses.

### Earth-Moon distance

Distance between the centers of the Earth and the Moon. It's used in the simulation of solar eclipses.

### Zoom

Zoom in factor. This factor increases the size of the image, hiding directions that are too far from mathematical horizon or North.

### <a name="camera-pitch-control">Camera pitch</a>

Changes the direction of look or the camera by tilting it up or down. The projection remains the same, so the horizon becomes curved.

### <a name="camera-yaw-control">Camera yaw</a>

Changes the direction of look or the camera by rotating it left or right.

### Dithering method

The scenes rendered contain wide gradients, often between very close colors. The typical 8 bit per color channel quantization appears too limited in such conditions, which results in banding. To fight it, [dithering](https://en.wikipedia.org/wiki/Dither#Digital_photography_and_image_processing) can be used.

ShowMySky previewer supports two dithering methods:

 * No dithering. This method just ignores the problem and lets the graphics system handle it as it can (might be OK for 10-bit monitors).
 * [Ordered dithering](https://en.wikipedia.org/wiki/Ordered_dithering), which is _theoretically_ optimal. In practice it often conflicts with LCD monitors' internal dithering algorithms, making the image even worse than without dithering.
 * Optimized blue noise with triangular remapping. This method is based on Bart Wronski's article ["Dithering part three – real world 2D quantization dithering"](https://bartwronski.com/2016/10/30/dithering-part-three-real-world-2d-quantization-dithering/), with some tweaks (see `dither_BlueTriang` GLSL function defined inside `GLWidget::initializeGL` and the comment at the top of ShowMySky/BlueNoiseTriangleRemapped.hpp).

### Dithering color depth

Dithering algorithm has to make some assumptions about the display device. Often, even the operating system of the computer can't tell what color depth a monitor has. This option lets the user set the correct color depth (or try them and choose the best).

The options are named as R/G/B where R, G, and B are number of bits in corresponding RGB channel. Here's the list of options:

 * 5/6/5 — this is the typical High color display mode;
 * 6/6/6 — this color depth is typical for LCD TN monitors, and sometimes others;
 * 8/8/8 — this should be tried first, unless you have a high-end monitor with support for 10 bit per color channel mode;
 * 10/10/10 — this is the option for high-end monitors with support for 10 bit per color channel mode. On the conventional 8-bit monitors this dithering mode will look as if dithering is disabled.

### Gradual color clipping

This option makes the colors too bright to display smoothly saturate in brightness instead of abruptly clamping at maximum value. This makes gradients that change from displayable colors into very bright colors nicer. The plot below shows the comparison of the simple clamping and gradual clipping as brightness of a given color `#fcb55c` increases.

<!--
gnuplot -p -e "set key autotitle columnhead right center;
set yrange [0 to 1.01];
set xlabel 'computed brightness';
set ylabel 'displayed brightness';
set term svg size 600 400;
set output 'gradual-clipping-plot.svg';
set datafile separator ',';
set mouse format '%.15g';
plot '/tmp/data.csv' using 1:2 with lines dashtype 2 linecolor rgb '#ff0000',
                  '' using 1:3 with lines dashtype 2 linecolor rgb '#00ff00',
                  '' using 1:4 with lines dashtype 2 linecolor rgb '#0000ff',
                  '' using 1:5 with lines linecolor rgb '#ff0000',
                  '' using 1:6 with lines linecolor rgb '#00ff00',
                  '' using 1:7 with lines linecolor rgb '#0000ff'"
-->

\image html gradual-clipping-plot.svg "Gradual clipping applied to input color channels of different brightness"

Below are two examples of the same scene, one with gradual color clipping turned off, and another with it turned on.

\image html gradual-color-clipping-off.png "Without gradual color clipping"
\image html gradual-color-clipping-on.png "With gradual color clipping"

### Glare

Real-life optical systems (including human eyes) never map a single cone of view to a single pixel. Instead, each pixel samples the whole field of view of the camera with varying weights, and the direction that it's supposed to display has a sharp peak in the weight function. On the one hand, this leads to starburst effect, blur, and other aberrations. On the other hand, it lets one see the colors of bright sources of light that would otherwise be seen as simply white points.

The _Glare_ checkbox enables a simplistic simulation of glare in the scene, letting one perceive brightness and color of the Sun, whose disk is almost always overexposed. In particular, we can see how the solar disk becomes bluish (which is invisible without glare) during sunrise watched through the ozone layer, as shown below.

\image html sunrise-from-50km.png "Sunrise viewed from 50 km altitude"

### Draw zero-order scattering layer

Zero-order scattering layer contains radiance from the Sun and from the ground. Technically, the ground doesn't emit visible light on its own, it just scatters the sunlight, but the way the simulation is organized puts it into the zero-order layer. Such separation is also useful for applications such as Stellarium, which renders both the Sun and the ground with its own means.

### Draw single scattering layers

Single scattering layers contain radiance from first-order scattering on the constituents of the atmosphere. This radiance is stored in separate textures, and is only controlled by this checkbox if the values haven't been merged into multiple scattering texture (see [<code>phase function type</code> parameter](md_doc_model_generation.html#phase-function-type) in atmosphere description file).

This option has sub-options corresponding to each separate single scattering layer. This lets one check how much light is scattered by each of these constituents. But note that enabling or disabling these sub-options only affects incoming radiance, it doesn't affect transmittance of the atmosphere. Enabling or disabling these layers is not the same as enabling or disabling a constituent of the atmosphere.

### Draw multiple scattering layer

This layer contains radiance from scattering orders higher than 1, and additionally the first-order scattering by the species whose phase function was marked as smooth (see [<code>phase function type</code> parameter](md_doc_model_generation.html#phase-function-type) in atmosphere description file).

### Light pollution luminance
<span style="background-color: red;">TODO</span>: write this section

### <a name="solar-spectrum-control">Solar spectrum</a>
<span style="background-color: red;">TODO</span>: write this section

### Texture filtering
<span style="background-color: red;">TODO</span>: write this section

### Compute single scattering on the fly
<span style="background-color: red;">TODO</span>: write this section

### Precompute double(-only) scattering on the fly
<span style="background-color: red;">TODO</span>: write this section

### Use eclipse-mode shaders
<span style="background-color: red;">TODO</span>: write this section

### Pseudo-mirror sky in the ground
<span style="background-color: red;">TODO</span>: write this section

### Reload shaders
<span style="background-color: red;">TODO</span>: write this section

### <a name="show-radiance-plot-control">Show radiance plot</a>
<span style="background-color: red;">TODO</span>: write this section

### Window decoration and status bar
<span style="background-color: red;">TODO</span>: write this section
